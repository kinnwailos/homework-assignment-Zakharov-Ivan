---
- name: Download and unpack Apache Kafka archive
  hosts: all
  become: yes
  vars:
    kafka_version: "3.6.1"
    download_url: "https://archive.apache.org/dist/kafka/{{ kafka_version }}/kafka_2.13-{{ kafka_version }}.tgz"
    download_dest: "/tmp/kafka_{{ kafka_version }}.tgz"
    extract_path: "/opt/kafka"

  tasks:
    - name: Install required packages for Debian/Ubuntu
      apt:
        name: 
          - wget
          - tar
          - ca-certificates
        state: present
        update_cache: no
      when: ansible_os_family == "Debian"

    - name: Install required packages for RHEL/CentOS
      dnf:
        name: 
          - wget
          - tar
        state: present
      when: ansible_os_family == "RedHat"

    - name: Create directory for extraction
      file:
        path: "{{ extract_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Download Kafka archive
      get_url:
        url: "{{ download_url }}"
        dest: "{{ download_dest }}"
        mode: '0644'
      register: download_result
      until: download_result is succeeded
      retries: 3
      delay: 5

    - name: Extract Kafka archive
      unarchive:
        src: "{{ download_dest }}"
        dest: "{{ extract_path }}"
        remote_src: yes
        creates: "{{ extract_path }}/kafka_2.13-{{ kafka_version }}"
